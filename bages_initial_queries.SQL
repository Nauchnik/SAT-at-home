DELETE FROM RESEARCH_BAGE_CHECKPOINT WHERE RESEARCH_ID = 3;

SET @FinishTime = DATE_ADD(DATE(NOW()), INTERVAL HOUR(NOW()) - 1 HOUR);

INSERT INTO RESEARCH_BAGE_CHECKPOINT(RESEARCH_ID, LAST_MOD_TIME) VALUES(3, @FinishTime);
INSERT INTO RESEARCH_BAGE_CHECKPOINT(RESEARCH_ID, LAST_MOD_TIME) VALUES(4, @FinishTime);

INSERT INTO PARTICIPANT_RESEARCH_CREDIT(RESEARCH_ID, PARTICIPANT_ID, CREDIT)
SELECT 3, user.ID, user.TOTAL_CREDIT - IFNULL(LATE_CREDIT.CREDIT, 0) - IFNULL(LS10INCO_CREDIT.CREDIT, 0) AS CREDIT
  FROM user
  LEFT JOIN
	(SELECT USERID, SUM(GRANTED_CREDIT) AS CREDIT
	  FROM result
	 WHERE MOD_TIME > @FinishTime
	   AND NAME LIKE '%diag10_2%'
	 GROUP BY USERID) AS LATE_CREDIT ON LATE_CREDIT.USERID = user.ID
  LEFT JOIN
	(SELECT USERID, SUM(GRANTED_CREDIT) AS CREDIT
	  FROM result
	 WHERE NAME LIKE '%ls_10_3_inc%'
	 GROUP BY USERID) AS LS10INCO_CREDIT ON LS10INCO_CREDIT.USERID = user.ID;

INSERT INTO PARTICIPANT_RESEARCH_CREDIT(RESEARCH_ID, PARTICIPANT_ID, CREDIT)
SELECT 4, USERID, SUM(GRANTED_CREDIT) AS CREDIT
  FROM result
 WHERE NAME LIKE '%ls_10_3_inc%' AND MOD_TIME <= @FinishTime
 GROUP BY USERID;