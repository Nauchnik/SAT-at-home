/*  Процедура обновления статистики в разрезе исследований  */

DROP PROCEDURE UPDATE_BAGE_STATISTICS;

DELIMITER ^

CREATE PROCEDURE UPDATE_BAGE_STATISTICS()
BEGIN
    -- Обновление статистики по парам квадратов 10-го порядка
    SET @Mask = '%diagl10_2%';
    SET @StartTime = (SELECT LAST_MOD_TIME FROM RESEARCH_BAGE_CHECKPOINT WHERE RESEARCH_ID = 3);
    SET @FinishTime = DATE_ADD(DATE(NOW()), INTERVAL HOUR(NOW()) HOUR);

   UPDATE PARTICIPANT_RESEARCH_CREDIT
     JOIN (SELECT USERID, SUM(GRANTED_CREDIT) AS GRANTED_CREDIT
             FROM result
            WHERE MOD_TIME > @StartTime AND MOD_TIME <= @FinishTime AND NAME LIKE @Mask
           GROUP BY USERID) AS HOUR_CREDIT ON HOUR_CREDIT.USERID = PARTICIPANT_RESEARCH_CREDIT.PARTICIPANT_ID AND PARTICIPANT_RESEARCH_CREDIT.RESEARCH_ID = 3
       SET PARTICIPANT_RESEARCH_CREDIT.CREDIT = PARTICIPANT_RESEARCH_CREDIT.CREDIT + HOUR_CREDIT.GRANTED_CREDIT
     WHERE PARTICIPANT_RESEARCH_CREDIT.RESEARCH_ID = 3;

    INSERT INTO PARTICIPANT_RESEARCH_CREDIT(RESEARCH_ID, PARTICIPANT_ID, CREDIT)
    SELECT 3, USERID, SUM(GRANTED_CREDIT) AS GRANTED_CREDIT
      FROM result
     WHERE MOD_TIME > @StartTime AND MOD_TIME <= @FinishTime AND NAME LIKE @Mask
       AND USERID NOT IN(SELECT PARTICIPANT_ID FROM PARTICIPANT_RESEARCH_CREDIT WHERE RESEARCH_ID = 3)
     GROUP BY USERID;

    UPDATE RESEARCH_BAGE_CHECKPOINT
       SET LAST_MOD_TIME = @FinishTime
     WHERE RESEARCH_ID = 3;

    -- Обновление статистики по тройкам квадратов 10-го порядка
    SET @Mask = '%ls_10_3_inc%';
    SET @StartTime = (SELECT LAST_MOD_TIME FROM RESEARCH_BAGE_CHECKPOINT WHERE RESEARCH_ID = 4);
    SET @FinishTime = DATE_ADD(DATE(NOW()), INTERVAL HOUR(NOW()) HOUR);

    UPDATE PARTICIPANT_RESEARCH_CREDIT
     JOIN (SELECT USERID, SUM(GRANTED_CREDIT) AS GRANTED_CREDIT
             FROM result
            WHERE MOD_TIME > @StartTime AND MOD_TIME <= @FinishTime AND NAME LIKE @Mask
           GROUP BY USERID) AS HOUR_CREDIT ON HOUR_CREDIT.USERID = PARTICIPANT_RESEARCH_CREDIT.PARTICIPANT_ID AND PARTICIPANT_RESEARCH_CREDIT.RESEARCH_ID = 4
       SET PARTICIPANT_RESEARCH_CREDIT.CREDIT = PARTICIPANT_RESEARCH_CREDIT.CREDIT + HOUR_CREDIT.GRANTED_CREDIT
     WHERE PARTICIPANT_RESEARCH_CREDIT.RESEARCH_ID = 4;

    INSERT INTO PARTICIPANT_RESEARCH_CREDIT(RESEARCH_ID, PARTICIPANT_ID, CREDIT)
    SELECT 4, USERID, SUM(GRANTED_CREDIT) AS GRANTED_CREDIT
      FROM result
     WHERE MOD_TIME > @StartTime AND MOD_TIME <= @FinishTime AND NAME LIKE @Mask
       AND USERID NOT IN(SELECT PARTICIPANT_ID FROM PARTICIPANT_RESEARCH_CREDIT WHERE RESEARCH_ID = 4)
     GROUP BY USERID;

    UPDATE RESEARCH_BAGE_CHECKPOINT
       SET LAST_MOD_TIME = @FinishTime
     WHERE RESEARCH_ID = 4;

END;
^

DELIMITER ;